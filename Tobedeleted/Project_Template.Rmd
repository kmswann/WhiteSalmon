---
output: 
  pdf_document:
    keep_tex: yes
    fig_caption: yes
    number_sections: yes
geometry: margin=2.54cm
title: "White Salmon River Pre and Post Dam Removal"
subtitle: "https://github.com/kmswann/WhiteSalmon.git"
author: "Kristine Swann"
fontsize: 12pt
mainfont: Times New Roman
editor_options: 
  chunk_output_type: console
---

\newpage
\tableofcontents 
\newpage
\listoftables 
\newpage
\listoffigures 
\newpage

```{r setup, include=FALSE}
# Set your working directory
getwd()
swd <- "C:/Users/krist/Box Sync/Spring 2020/R/Environmental_Data_Analytics_2020/WhiteSalmon"

# Load your packages
library(trend)
library(zoo)
library(dataRetrieval);
library (ggplot2);
library(tidyverse);
library(zoo);
library(EGRET); 
library(dplyr); 
library(magrittr); 
library(lubridate);
library(pastecs);
library(leaflet);

# Set your ggplot theme
mytheme <- theme_classic(base_size = 14) +
theme(axis.text = element_text(color = "black"),
legend.position = "bottom")
theme_set(mytheme)

# Load your datasets
siteNo<-'14123500'#Underwood gage station
pcode = '00060' #discharge cfs
scode="00003" #mean
start.date = "1912-11-01" 
end.date="2020-09-30"
#Load Data
ws<- readNWISdv(siteNumbers = siteNo, parameterCd = pcode, statCd = scode, startDate=start.date, endDate=end.date)
```


# Rationale and Research Questions

The White Salmon River (White Salmon) is a tributary of the Columbia River in Southern Washington. It provides habitat for at least 5 threatened and endangered fish species and is one of the best white water rivers in the US (Pesanti, 2016). In 1913, a hydroelectric dam, the Condit Dam, was built 3 miles from the mouth of the river (Figure 1: White Salmon River). The dam acted as barrier to salmon species and also to kayakers who paddle both upper reaches of the river and a short section below the dam.

Below hydroelectric dams, the downstream discharge rates – measured in cubic feet per second (cfs) – become altered based on energy production (Grantham et al, 2014). These unnatural flows tend to lower the amount of water in the river during the dry season, as water is conserved in the upstream reservoir for continued energy production. This causes fewer days where the river downstream can be paddled, but more importantly, it is deleterious to salmon habitat (URS, 2005). In 2011, the Condit Dam was removed from the White Salmon. It is assumed that dam removal will benefit both salmon and white water enthusiasts through not only having a physical barrier removed but through restoring natural stream flow conditions on the White Salmon River.  

This is a multipronged assessment of streamflow trends in the White Salmon pre and post dam removal. I answer the question as to whether flows have changed after dam removal through flood interval comparisons, seasonal mann kendall time series assessments, and integration of number of paddleable days based on discharge rates. 

```{r watershed map, include=FALSE}


```

\newpage

# Dataset Information

Data used here include daily stream flow data and precipitation data for water years 1987-2018. Stream flow data was sourced from a USGS stream gauge station less than one mile downstream of the Condit Dam site (Station ID: 14123500). Additional data on required gauge height and cfs levels for paddling various sections of the White Salmon were sourced through communications with Wet Planet Whitewater, a rafting company located along the White Salmon. 
Additional spatial data were used for mapping purposes. The sources of these data can be found in the associated README.md file. 

USGS stream gauge data was rearranged into water years format, which shifts the 'year' to be the period between October 1st of one year and September 30th of the following year, with the year designated by the calendar year in which that period ends (i.e. the calendar year for September). The data was split into three groups: 
Water Years 1987 - 2011: Pre dam removal data
Water Years 2013-2019: Post dam removal data 
Water Years 2003 - 2011: Pre dam removal data (equal years to post dam removal data)
Note that 2012 data was left out because that was the water year the dam was removed, and the sediment plug from the dam removal could have impacted flows that year.  


```{r data wrangling for descriptive stats and visuals, include=FALSE}
#Rename columns
ws <- renameNWISColumns(ws)
colnames(ws)

#################################################################################################
#PULLING SUMMARY STATS OUT OF DATA BASED ON TIME PERIODS
#################################################################################################

#Create data frame
sum.stats <- as.data.frame(matrix(nrow=8, ncol=5))
  colnames(sum.stats) <- c("Statistics","p1987-2019","p1987-2011","p2012-2019", "p2003-2011")
#First column
   sum.stats$Statistics <- c("Min","10th percentile","25th percentile","Median","Mean","75th percentile", "90th percentile","Max")
   
#Function to fill in second column
  #data.frame[row number, column number]
gen_stats = function(data, column.no){
  sum.stats[1,column.no] <- min(data$Flow);               
  sum.stats[2,column.no] <- quantile(data$Flow, 0.10);             sum.stats[3,column.no] <- quantile(data$Flow, 0.25);
  sum.stats[4,column.no] <- median(data$Flow);                     sum.stats[5,column.no] <- mean(data$Flow);
  sum.stats[6,column.no] <- quantile(data$Flow, 0.75);             sum.stats[7,column.no] <- quantile(data$Flow, 0.90);
  sum.stats[8,column.no] <- max(data$Flow);               
  
  return(sum.stats)
}
sum.stats <- gen_stats(ws, 2)
sum.stats$`p1987-2019` <- round(sum.stats$`p1987-2019`,3)
sum.stats

#Subset data and rerun function
ws.pre2012 <- subset(ws, Date<="2011-12-31");          summary(ws.pre2012$Date)
ws.post2012 <- subset(ws, Date>="2012-01-01");         summary(ws.post2012$Date)
ws.equalpre2012 <- subset(ws.pre2012, Date>="2003-01-01");         summary(ws.equalpre2012$Date)

#call the function to calculate summary statistics
sum.stats <- gen_stats(ws.pre2012,3)
sum.stats <- gen_stats(ws.post2012,4)
sum.stats <- gen_stats(ws.equalpre2012,5)

#round values
sum.stats[,c(2:4)]<- round(sum.stats[,c(2:4)],3)
  sum.stats

#################################################################################################
#LOOKING AT SEASONAL VARIATION
#################################################################################################

#Separate Date into Years/Months
ws$Year <- year(ws$Date)
ws$Month <- month(ws$Date)
#Number the years from start
ws$YFS <- (ws$Year-min(ws$Year))

#Create WaterYear
ws$WaterYear <- ifelse(ws$Month>=10,ws$Year+1,ws$Year)
#ws$WaterYear <- as.Date(ws$WaterYear, format = "%Y")
#Number the wateryears from start
ws$WaterYFS <- (ws$WaterYear-min(ws$WaterYear))


#Create a summed month flow. 
month.flow <- ws %>% 
  group_by(WaterYear,WaterYFS, Year, Month) %>% 
  summarise(Total_cfs = sum(Flow, na.rm=T), n=n()) %>%  
  round(3)
#turn the summed month flow into drataframe 
month.flow <- as.data.frame(month.flow)
#fix the dates up for seasonal work
month.flow$Date <- as.Date(paste(month.flow$Year, month.flow$Month, 1, sep="-"), format = "%Y-%m-%d")

#create a summed annual flow. 
annual.flow <- ws %>%
  group_by(WaterYear,WaterYFS) %>%
  summarise(Total_cfs = sum(Flow, na.rm=T), n=n()) %>%  round(3)
#turn summed annual flow into dataframe
annual.flow <- as.data.frame(annual.flow);  
#remove those missing more than 10%
annual.flow <- subset(annual.flow, n>=330)

```

\newpage

# Exploratory Analysis 

Daily data over 33 years results in numbers of observations well above 10,000 (Figure 2: Daily Discharge Data; Table 2: Descriptive Statistics). The data here are generally positively skewed with outliers – this is expected to occur given flooding recurrence. A log transformation was carried out on monthly data but outliers remained; therefore, it was not used.


\newpage

# Analysis



## Question 1: <insert specific question here and add additional subsections for additional questions below, if needed>

## Question 2: 




\newpage

# Summary and Conclusions


\newpage

# References
<add references here if relevant, otherwise delete this section> 
